<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NetmerianBot</title>
  <style>
    :root{
      /* Netmera */
      --brand-blue:#2EC3E0;
      --brand-green:#8CCB3B;

      /* Zeminler */
      --bg:#08132A;
      --panel:#0E1733;

      /* Balonlar (kontrast artırıldı) */
      --bot:#0F1C3F;   /* lacivert */
      --user:#10364E;  /* maviye yakın */

      --text:#F2F6FF;
      --muted:#9FB1D8;
      --ring:#2B3D83;

      --chip:#17224A;
      --chip-hover:#1E2C5D;

      --code-bg:#0B1536;
      --code-border:#2C47A3;

      --link:#DDF6FF;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 20% -10%, rgba(46,195,224,.15) 0%, transparent 55%),
                  linear-gradient(135deg, var(--bg) 0%, #050D22 100%);
      color:var(--text);
      font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", Arial;
      display:flex; align-items:center; justify-content:center;
    }

    .shell{
      width:min(1000px, 94vw);
      height:min(90vh, 920px);
      background:var(--panel);
      border:1px solid rgba(255,255,255,.06);
      border-radius:18px;
      box-shadow:0 24px 70px rgba(6,10,28,.55), inset 0 0 0 1px rgba(255,255,255,.03);
      display:grid; grid-template-rows:40px 56px 1fr 92px; overflow:hidden;
    }

    /* Üst marka şeridi */
    .brandbar{
      background:linear-gradient(90deg, var(--brand-blue), var(--brand-green));
      display:flex; align-items:center; justify-content:center;
      color:#0B1224; font-weight:700; letter-spacing:.2px; font-size:14px;
    }

    header{
      display:flex; align-items:center; gap:12px; padding:0 18px;
      background:#0F1B3A;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .dot{width:10px;height:10px;border-radius:50%;
      background:linear-gradient(135deg,var(--brand-blue),var(--brand-green));
      box-shadow:0 0 12px rgba(46,195,224,.9)}
    header h1{font-size:15px; letter-spacing:.3px; margin:0; color:#EAF2FF}
    header .spacer{flex:1}
    header a{color:var(--link); text-decoration:none; font-size:13px}

    /* Sade ve düz bir konuşma alanı */
    #log{
      padding:18px; overflow:auto; scroll-behavior:smooth;
      background: var(--panel);
      display:flex; flex-direction:column;
    }

    .msg{display:flex; gap:10px; margin:12px 0; max-width:85%}
    .msg.user{margin-left:auto; flex-direction:row-reverse}

    .bubble{
      padding:12px 14px; border-radius:14px;
      background:var(--bot); color:var(--text);
      border:1px solid var(--ring);
      box-shadow:0 10px 28px rgba(0,0,0,.25);
      white-space:pre-wrap; word-break:break-word;
    }
    .user .bubble{
      background:var(--user);
      border-color:rgba(46,195,224,.55);
    }
    .msg small{color:var(--muted); align-self:flex-end}

    .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .chip{
      font-size:13px;color:#E8F7FF;background:var(--chip);
      padding:8px 10px; border-radius:999px; cursor:pointer;
      border:1px solid rgba(46,195,224,.35)
    }
    .chip:hover{background:var(--chip-hover)}

    footer{
      display:grid; grid-template-columns:1fr auto; gap:10px; padding:12px 14px;
      background:#0C1533; border-top:1px solid rgba(255,255,255,.06);
    }
    textarea{
      resize:none; height:60px; padding:14px 12px; border-radius:12px;
      background:#0A1636; color:var(--text);
      border:1px solid #27408F; outline: none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
    }
    textarea:focus{border-color:var(--brand-blue)}
    button{
      min-width:120px; border-radius:12px; border:1px solid rgba(255,255,255,.12); color:#0B1224;
      background:linear-gradient(135deg,var(--brand-blue),var(--brand-green));
      font-weight:700; letter-spacing:.3px; cursor:pointer;
      box-shadow:0 8px 22px rgba(46,195,224,.35);
    }
    button[disabled]{opacity:.7; cursor:not-allowed}

    .meta{font-size:12px;color:#CFE4FF;margin-top:6px}
    a.cite{color:var(--link); text-decoration:underline; margin-right:10px}

    /* Kod blokları */
    .bubble pre{
      background:var(--code-bg)!important; border:1px solid var(--code-border);
      border-radius:12px; padding:14px; overflow:auto
    }
    .code-wrap{position:relative; margin:10px 0}
    .code-tools{position:absolute; top:6px; right:6px; display:flex; gap:6px}
    .code-tools .lang{
      font:12px/1 monospace; color:#CFE0FF; background:#0F1C46;
      border:1px solid #2E50C7; border-radius:8px; padding:4px 8px
    }
    .code-tools .copy{
      font:12px/1 monospace; color:#061022;
      background:linear-gradient(135deg,var(--brand-blue),var(--brand-green));
      border:1px solid rgba(255,255,255,.12); border-radius:8px; padding:4px 8px; cursor:pointer
    }
    .code-tools .copy.copied{background:#1C6C2C; color:#EFFFF1}
  </style>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark-dimmed.min.css">
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>
</head>
<body>
  <div class="shell">
    <div class="brandbar">Netmera • AI Assistant</div>

    <header>
      <div class="dot"></div>
      <h1>NetmerianBot</h1>
      <div class="spacer"></div>
      <a href="/health" target="_blank">health</a>
      <span style="opacity:.35">·</span>
      <a href="/debug" target="_blank">debug</a>
    </header>

    <main id="log"></main>

    <footer>
      <textarea id="inp" placeholder="Ask something about Netmera docs… (Shift+Enter = newline)"></textarea>
      <button id="send">Send ↵</button>
    </footer>
  </div>

  <script>
    const log = document.getElementById('log');
    const inp = document.getElementById('inp');
    const btn = document.getElementById('send');

    function renderMarkdown(md){
      marked.setOptions({
        mangle:false, headerIds:false, breaks:true, gfm:true,
        highlight: (code, lang) => {
          try { return hljs.highlight(code, {language: lang}).value; }
          catch { return hljs.highlightAuto(code).value; }
        }
      });
      let html = marked.parse(md || "");
      html = DOMPurify.sanitize(html);
      const tmp = document.createElement('div'); tmp.innerHTML = html;
      tmp.querySelectorAll('pre>code').forEach((codeEl) => {
        const pre = codeEl.parentElement;
        const wrap = document.createElement('div'); wrap.className = 'code-wrap';
        pre.replaceWith(wrap); wrap.appendChild(pre);
        const tools = document.createElement('div'); tools.className = 'code-tools';
        const lang = [...codeEl.classList].find(c=>c.startsWith('language-'));
        const langLabel = document.createElement('span'); langLabel.className = 'lang';
        langLabel.textContent = (lang ? lang.replace('language-','') : 'text');
        const copy = document.createElement('button'); copy.className = 'copy'; copy.textContent = 'Copy';
        copy.addEventListener('click', async () => {
          try{ await navigator.clipboard.writeText(codeEl.textContent);
               copy.textContent='Copied'; copy.classList.add('copied');
               setTimeout(()=>{copy.textContent='Copy'; copy.classList.remove('copied')},1100);
          }catch(e){ console.error(e); }
        });
        tools.appendChild(langLabel); tools.appendChild(copy);
        wrap.appendChild(tools);
      });
      return tmp.innerHTML;
    }

    function el(html){ const t = document.createElement('template'); t.innerHTML = html.trim(); return t.content.firstChild; }
    function toLinkable(x){ try{ const u = new URL(x); return `<a class="cite" href="${u.href}" target="_blank" rel="noopener">source</a>`; } catch{ return `<span class="cite" title="${x}">ref</span>`; } }

    function addMsg(content, who="bot", extras=null, isMarkdown=false){
      const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      const msg = el(`<div class="msg ${who}"><div class="bubble"></div><small>${who==="user"?"You":"Bot"} · ${time}</small></div>`);
      const bubble = msg.querySelector('.bubble');
      bubble[isMarkdown ? 'innerHTML' : 'textContent'] = isMarkdown ? renderMarkdown(content) : content;
      log.appendChild(msg);

      if(extras?.citations?.length){
        const meta = el(`<div class="meta"></div>`);
        extras.citations.forEach(c => meta.insertAdjacentHTML('beforeend', toLinkable(c)));
        bubble.after(meta);
      }
      if(extras?.suggestions?.length){
        const wrap = el(`<div class="chips"></div>`);
        extras.suggestions.slice(0,4).forEach(s => { const chip = el(`<div class="chip">${s}</div>`); chip.addEventListener('click', () => send(s)); wrap.appendChild(chip); });
        msg.appendChild(wrap);
      }
      log.scrollTop = log.scrollHeight;
      return msg;
    }

    function addTyping(){
      const m = el(`<div class="msg"><div class="bubble">typing…</div><small>Bot · …</small></div>`);
      log.appendChild(m); log.scrollTop = log.scrollHeight; return m;
    }

    async function send(text){
      if(!text || !text.trim()) return;
      addMsg(text.trim(), "user");
      inp.value = ""; btn.disabled = true; inp.disabled = true;
      const typing = addTyping();
      try{
        const r = await fetch("/chat", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ query: text.trim() }) });
        if(!r.ok) throw new Error(await r.text());
        const data = await r.json();
        typing.remove();
        addMsg(data.answer || "(no answer)", "bot", {citations:data.citations||[], suggestions:data.suggestions||[]}, true);
      }catch(err){
        typing.remove(); addMsg("⚠️ Error: " + (err.message || err), "bot");
      }finally{
        btn.disabled = false; inp.disabled = false; inp.focus();
      }
    }

    btn.addEventListener('click', () => send(inp.value));
    inp.addEventListener('keydown', (e) => { if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); send(inp.value); }});
    addMsg("Merhaba! Netmera dokümanları hakkında sorular sorabilirsin. Kod bloklarını ```bash / ```python şeklinde gönderirsen kopyalanabilir olarak görünür.", "bot", null, true);
  </script>
</body>
</html>
